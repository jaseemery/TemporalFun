using Microsoft.Extensions.Logging;
using Moq;
using FluentAssertions;
using Xunit;
using TemporalWorkerApp.Loaders;
using TemporalWorkerApp.Managers;
using TemporalWorkerApp.Watchers;
using Temporalio.Workflows;
using System.Reflection;

namespace TemporalWorker.Tests;

public class WorkflowLoaderTests : IDisposable
{
    private readonly Mock<ILogger<WorkflowLoader>> _mockLogger;
    private readonly Mock<ILogger<HotReloadManager>> _mockHotReloadLogger;
    private readonly Mock<ILogger<PackageWatcher>> _mockPackageWatcherLogger;
    private readonly HotReloadManager _hotReloadManager;
    private readonly WorkflowLoader _workflowLoader;

    public WorkflowLoaderTests()
    {
        _mockLogger = new Mock<ILogger<WorkflowLoader>>();
        _mockHotReloadLogger = new Mock<ILogger<HotReloadManager>>();
        _mockPackageWatcherLogger = new Mock<ILogger<PackageWatcher>>();
        
        _hotReloadManager = new HotReloadManager(_mockHotReloadLogger.Object, _mockPackageWatcherLogger.Object);
        _workflowLoader = new WorkflowLoader(_mockLogger.Object, _hotReloadManager);
    }

    [Fact]
    public void Constructor_ShouldInitializeProperly()
    {
        // Arrange & Act & Assert
        _workflowLoader.Should().NotBeNull();
    }

    [Fact]
    public void LoadWorkflowsFromAssemblies_ShouldReturnWorkflowTypes()
    {
        // Arrange
        var logger = Mock.Of<ILogger>();

        // Act
        var workflows = WorkflowLoader.LoadWorkflowsFromAssemblies(logger);

        // Assert
        workflows.Should().NotBeNull();
        workflows.Should().BeAssignableTo<IEnumerable<Type>>();
    }

    [Fact]
    public void LoadWorkflowsFromAssemblies_ShouldFindWorkflowsInCurrentAssembly()
    {
        // Arrange
        var logger = Mock.Of<ILogger>();

        // Act
        var workflows = WorkflowLoader.LoadWorkflowsFromAssemblies(logger);
        var workflowList = workflows.ToList();

        // Assert
        workflowList.Should().Contain(w => w.Name.Contains("Workflow"));
    }

    [Fact]
    public async Task LoadWorkflowsWithHotReloadAsync_ShouldCallHotReloadManager()
    {
        // Arrange & Act
        var result = await _workflowLoader.LoadWorkflowsWithHotReloadAsync();

        // Assert
        result.Should().NotBeNull();
        result.Should().BeAssignableTo<IEnumerable<Type>>();
    }

    [Fact]
    public void WorkflowsChanged_EventShouldBeTriggered()
    {
        // Arrange
        var eventTriggered = false;
        var receivedWorkflows = new List<Type>();

        _workflowLoader.WorkflowsChanged += (workflows) =>
        {
            eventTriggered = true;
            receivedWorkflows.AddRange(workflows);
        };

        var testWorkflows = new List<Type> { typeof(TestWorkflow) };

        // Act
        _hotReloadManager.WorkflowsReloaded?.Invoke(testWorkflows);

        // Assert
        eventTriggered.Should().BeTrue();
        receivedWorkflows.Should().Contain(typeof(TestWorkflow));
    }

    [Fact]
    public void Dispose_ShouldCleanupProperly()
    {
        // Arrange & Act
        _workflowLoader.Dispose();

        // Assert - Should not throw
        Assert.True(true);
    }

    public void Dispose()
    {
        _workflowLoader?.Dispose();
        _hotReloadManager?.Dispose();
    }
}

// Test workflow class for testing
[Workflow("test-workflow")]
public class TestWorkflow
{
    [WorkflowRun]
    public async Task<string> RunAsync()
    {
        await Task.Delay(100);
        return "test";
    }
}